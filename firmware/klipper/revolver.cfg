# OpenRevolver Klipper Configuration
# This is a sample configuration for the OpenRevolver system

[revolver]
# Number of nozzle positions in the revolver
nozzle_count: 6
# Servo/stepper pin for rotation
rotation_pin: PA1
# Rotation angles for each position (degrees)
position_0_angle: 0
position_1_angle: 60
position_2_angle: 120
position_3_angle: 180
position_4_angle: 240
position_5_angle: 300
# Time to wait after rotation (seconds)
rotation_settle_time: 0.5

[revolver_nozzle 0]
# 0.4mm standard nozzle
diameter: 0.4
material: PLA
max_temp: 250
wireless_id: NOZZLE_0_MAC

[revolver_nozzle 1]
# 0.2mm detail nozzle
diameter: 0.2
material: PLA
max_temp: 250
wireless_id: NOZZLE_1_MAC

[revolver_nozzle 2]
# 0.6mm draft nozzle
diameter: 0.6
material: PETG
max_temp: 280
wireless_id: NOZZLE_2_MAC

[revolver_nozzle 3]
# 0.4mm high-temp nozzle
diameter: 0.4
material: ABS
max_temp: 300
wireless_id: NOZZLE_3_MAC

[revolver_nozzle 4]
# 0.8mm high-flow nozzle
diameter: 0.8
material: PLA
max_temp: 250
wireless_id: NOZZLE_4_MAC

[revolver_nozzle 5]
# 1.0mm ultra-flow nozzle
diameter: 1.0
material: PETG
max_temp: 280
wireless_id: NOZZLE_5_MAC

# Inductive heating configuration
[inductive_heater]
coil_pin: PB2
frequency: 100000  # 100kHz
max_power: 25.0    # Watts
pid_Kp: 22.2
pid_Ki: 1.08
pid_Kd: 114

# Wireless communication
[revolver_wireless]
spi_bus: spi1
cs_pin: PA4
# ESP32 or similar wireless MCU settings
communication_timeout: 1.0

# Macros for tool/nozzle selection
[gcode_macro REVOLVER_SELECT]
description: Select a specific tool and nozzle combination
gcode:
    {% set tool = params.TOOL|default(0)|int %}
    {% set nozzle = params.NOZZLE|default(0)|int %}
    
    # Safety checks
    {% if nozzle < 0 or nozzle >= 6 %}
        {action_raise_error("Invalid nozzle index")}
    {% endif %}
    
    REVOLVER_ROTATE POSITION={nozzle}
    REVOLVER_ACTIVATE_NOZZLE INDEX={nozzle}
    
    # Update pressure advance for nozzle size
    {% if printer.revolver.nozzles[nozzle].diameter == 0.2 %}
        SET_PRESSURE_ADVANCE ADVANCE=0.035
    {% elif printer.revolver.nozzles[nozzle].diameter == 0.4 %}
        SET_PRESSURE_ADVANCE ADVANCE=0.045
    {% elif printer.revolver.nozzles[nozzle].diameter == 0.6 %}
        SET_PRESSURE_ADVANCE ADVANCE=0.055
    {% elif printer.revolver.nozzles[nozzle].diameter >= 0.8 %}
        SET_PRESSURE_ADVANCE ADVANCE=0.065
    {% endif %}

[gcode_macro REVOLVER_ROTATE]
description: Rotate revolver to specific position
gcode:
    {% set position = params.POSITION|int %}
    {% set angle = printer.revolver.position_angles[position] %}
    
    # Move to safe Z height
    G91
    G1 Z5 F1000
    G90
    
    # Rotate servo to position
    SET_SERVO SERVO=revolver_servo ANGLE={angle}
    G4 P{printer.revolver.rotation_settle_time * 1000}
    
    # Return to previous Z
    G91
    G1 Z-5 F1000
    G90

[gcode_macro REVOLVER_ACTIVATE_NOZZLE]
description: Activate wireless nozzle heating
gcode:
    {% set index = params.INDEX|int %}
    {% set target_temp = params.TEMP|default(0)|float %}
    
    # Send wireless command to activate nozzle
    REVOLVER_WIRELESS_CMD NOZZLE={index} COMMAND=ACTIVATE
    
    # Start inductive heating if temperature requested
    {% if target_temp > 0 %}
        REVOLVER_HEAT_NOZZLE INDEX={index} TARGET={target_temp}
    {% endif %}

[gcode_macro T0]
# Override standard tool change for compatibility
rename_existing: T0_ORIGINAL
gcode:
    # Map T0 to nozzle 0 by default
    REVOLVER_SELECT TOOL=0 NOZZLE=0

# Quick nozzle selection macros
[gcode_macro SELECT_DETAIL_NOZZLE]
gcode:
    REVOLVER_SELECT NOZZLE=1  # 0.2mm

[gcode_macro SELECT_STANDARD_NOZZLE]
gcode:
    REVOLVER_SELECT NOZZLE=0  # 0.4mm

[gcode_macro SELECT_DRAFT_NOZZLE]
gcode:
    REVOLVER_SELECT NOZZLE=2  # 0.6mm

[gcode_macro SELECT_HIGHFLOW_NOZZLE]
gcode:
    REVOLVER_SELECT NOZZLE=4  # 0.8mm
